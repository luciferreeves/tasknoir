name: ğŸš€ Deploy Task Noir to AWS

on:
  push:
    branches: [ main, master ]

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-south-1'

jobs:
  # ğŸ§ª Testing and Linting Job
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ¯ Cache Prisma
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          node_modules/.prisma
        key: ${{ runner.os }}-prisma-${{ hashFiles('**/prisma/schema.prisma') }}
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ¨ Run ESLint
      run: npm run lint
      
    - name: ğŸ—ï¸ TypeScript type check
      run: npx tsc --noEmit
      
    - name: ğŸ“‹ Prisma validation
      run: npx prisma validate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ğŸš€ Deployment Job
  deploy:
    name: ğŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ¯ Cache Prisma
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          node_modules/.prisma
        key: ${{ runner.os }}-prisma-${{ hashFiles('**/prisma/schema.prisma') }}
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ¯ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—„ï¸ Generate Prisma client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: ğŸ”„ Run database migrations
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: ğŸš€ Deploy to AWS with SST
      id: deploy
      run: |
        echo "ğŸš€ Starting deployment to production..."
        OUTPUT=$(npx sst deploy --stage production)
        echo "$OUTPUT"
        echo "âœ… Deployment completed successfully!"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        
    - name: ğŸ©º Health check
      run: |
        echo "ğŸ” Waiting for deployment to be ready..."
        sleep 30
        
        DEPLOY_URL="${{ secrets.NEXTAUTH_URL }}"
        echo "ğŸŒ Testing health endpoint: ${DEPLOY_URL}/api/health"
        
        for i in {1..5}; do
          RESPONSE=$(curl -s "${DEPLOY_URL}/api/health" || echo "failed")
          
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed on attempt $i"
            echo "ğŸ“‹ Response: $RESPONSE"
            break
          else
            echo "âŒ Health check failed on attempt $i, retrying in 10s..."
            echo "ğŸ“‹ Response: $RESPONSE"
            sleep 10
          fi
          
          if [ $i -eq 5 ]; then
            echo "ğŸ’¥ Health check failed after 5 attempts"
            exit 1
          fi
        done
        
    - name: ğŸ‰ Deployment success notification
      if: success()
      run: |
        echo "ğŸŠ Task Noir successfully deployed to AWS!"
        echo "ğŸŒŸ Your app is live and ready for users!"
        
    - name: ğŸ’¥ Deployment failure notification
      if: failure()
      run: |
        echo "ğŸ˜ Deployment failed. Check the logs above for details."
        echo "ğŸ”§ Common issues to check:"
        echo "   - Environment variables are set correctly"
        echo "   - AWS credentials have proper permissions"
        echo "   - Database is accessible from AWS"
